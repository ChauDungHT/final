CREATE DATABASE final;

USE final;

CREATE TABLE Users (
    UserID INT AUTO_INCREMENT PRIMARY KEY,
    Username VARCHAR(50) CHARACTER SET utf8mb4 UNIQUE NOT NULL,
    Email VARCHAR(100) CHARACTER SET utf8mb4 UNIQUE NOT NULL,
    Password VARCHAR(255) NOT NULL,
    FullName VARCHAR(100) CHARACTER SET utf8mb4 NOT NULL,
    Role VARCHAR(20) CHARACTER SET utf8mb4 NOT NULL,
    CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdatedDate DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    IsActive BOOLEAN DEFAULT TRUE,
    CHECK (Role IN ('Admin', 'Student'))
) ENGINE=InnoDB;

CREATE TABLE Categories (
    CategoryID INT AUTO_INCREMENT PRIMARY KEY,
    CategoryName VARCHAR(100) CHARACTER SET utf8mb4 NOT NULL,
    Description VARCHAR(500) CHARACTER SET utf8mb4,
    CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    CreatedBy INT,
    IsActive BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (CreatedBy) REFERENCES Users(UserID)
) ENGINE=InnoDB;

CREATE TABLE Assignments (
    AssignmentID INT AUTO_INCREMENT PRIMARY KEY,
    Title VARCHAR(200) CHARACTER SET utf8mb4 NOT NULL,
    Description TEXT,
    CategoryID INT,
    DueDate DATETIME NOT NULL,
    CreatedBy INT,
    CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    UpdatedDate DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    IsActive BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (CategoryID) REFERENCES Categories(CategoryID),
    FOREIGN KEY (CreatedBy) REFERENCES Users(UserID)
) ENGINE=InnoDB;

CREATE TABLE Submissions (
    SubmissionID INT AUTO_INCREMENT PRIMARY KEY,
    AssignmentID INT,
    StudentID INT,
    FileName VARCHAR(255) CHARACTER SET utf8mb4 NOT NULL,
    FilePath VARCHAR(500) CHARACTER SET utf8mb4 NOT NULL,
    FileSize BIGINT,
    SubmissionDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    PlagiarismScore DECIMAL(5,2),
    Status VARCHAR(20) CHARACTER SET utf8mb4 DEFAULT 'Pending',
    ReviewedBy INT,
    ReviewDate DATETIME,
    Comments TEXT,
    IsActive BOOLEAN DEFAULT TRUE,
    FOREIGN KEY (AssignmentID) REFERENCES Assignments(AssignmentID),
    FOREIGN KEY (StudentID) REFERENCES Users(UserID),
    FOREIGN KEY (ReviewedBy) REFERENCES Users(UserID),
    CHECK (Status IN ('Pending', 'Approved', 'Rejected', 'Under Review'))
) ENGINE=InnoDB;

CREATE TABLE PlagiarismResults (
    ResultID INT AUTO_INCREMENT PRIMARY KEY,
    SubmissionID INT,
    OriginalText TEXT,
    PlagiarizedText TEXT,
    SourceURL VARCHAR(500) CHARACTER SET utf8mb4,
    SimilarityScore DECIMAL(5,2),
    StartPosition INT,
    EndPosition INT,
    CheckDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (SubmissionID) REFERENCES Submissions(SubmissionID)
) ENGINE=InnoDB;

CREATE TABLE AIInteractions (
    InteractionID INT AUTO_INCREMENT PRIMARY KEY,
    SubmissionID INT,
    UserID INT,
    Question TEXT,
    Response TEXT,
    InteractionType VARCHAR(50) CHARACTER SET utf8mb4,
    CreatedDate DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (SubmissionID) REFERENCES Submissions(SubmissionID),
    FOREIGN KEY (UserID) REFERENCES Users(UserID),
    CHECK (InteractionType IN ('Summary', 'QA', 'Analysis'))
) ENGINE=InnoDB;

D·ªØ li·ªáu bao g·ªìm:
INSERT INTO Users (Username, Email, Password, FullName, Role)
VALUES 
('admin1', 'admin1@mail.com', 'pass123', 'Admin One', 'Admin'),
('admin2', 'admin2@mail.com', 'pass123', 'Admin Two', 'Admin'),
('admin3', 'admin3@mail.com', 'pass123', 'Admin Three', 'Admin'),
('admin4', 'admin4@mail.com', 'pass123', 'Admin Four', 'Admin'),
('admin5', 'admin5@mail.com', 'pass123', 'Admin Five', 'Admin'),
('student1', 'student1@mail.com', 'pass123', 'Student One', 'Student'),
('student2', 'student2@mail.com', 'pass123', 'Student Two', 'Student'),
('student3', 'student3@mail.com', 'pass123', 'Student Three', 'Student'),
('student4', 'student4@mail.com', 'pass123', 'Student Four', 'Student'),
('student5', 'student5@mail.com', 'pass123', 'Student Five', 'Student');

INSERT INTO Categories (CategoryName, Description, CreatedBy)
VALUES
('Math', 'To√°n h·ªçc c∆° b·∫£n', 1),
('Physics', 'V·∫≠t l√Ω ƒë·∫°i c∆∞∆°ng', 1),
('Programming', 'L·∫≠p tr√¨nh cƒÉn b·∫£n', 2),
('AI', 'Tr√≠ tu·ªá nh√¢n t·∫°o', 2),
('Database', 'C∆° s·ªü d·ªØ li·ªáu', 3),
('English', 'Ti·∫øng Anh h·ªçc thu·∫≠t', 3),
('Writing', 'Vi·∫øt h·ªçc thu·∫≠t', 4),
('History', 'L·ªãch s·ª≠ th·∫ø gi·ªõi', 4),
('Chemistry', 'H√≥a h·ªçc h·ªØu c∆°', 5),
('Biology', 'Sinh h·ªçc ph√¢n t·ª≠', 5);

INSERT INTO Assignments (Title, Description, CategoryID, DueDate, CreatedBy)
VALUES
('B√†i to√°n ƒë·∫°i s·ªë', 'Gi·∫£i h·ªá ph∆∞∆°ng tr√¨nh', 1, '2025-06-01', 1),
('ƒê·ªãnh lu·∫≠t Newton', 'Tr√¨nh b√†y ƒë·ªãnh lu·∫≠t 2', 2, '2025-06-01', 1),
('Vi·∫øt ch∆∞∆°ng tr√¨nh t√≠nh t·ªïng', 'S·ª≠ d·ª•ng C++', 3, '2025-06-02', 2),
('Ph√¢n t√≠ch b√†i to√°n ML', '√Åp d·ª•ng kNN', 4, '2025-06-03', 2),
('T·ªëi ∆∞u SQL', 'Vi·∫øt truy v·∫•n t·ªëi ∆∞u', 5, '2025-06-04', 3),
('Vi·∫øt email h·ªçc thu·∫≠t', 'C·∫•u tr√∫c email formal', 6, '2025-06-01', 3),
('B√†i lu·∫≠n vƒÉn', 'Ch·ªß ƒë·ªÅ t·ª± ch·ªçn', 7, '2025-06-05', 4),
('Chi·∫øn tranh th·∫ø gi·ªõi', 'Ph√¢n t√≠ch nguy√™n nh√¢n', 8, '2025-06-05', 4),
('H√≥a h·ªçc h·ªØu c∆° c∆° b·∫£n', 'Nh√≥m ch·ª©c', 9, '2025-06-02', 5),
('Sinh h·ªçc DNA', 'C·∫•u tr√∫c gen', 10, '2025-06-02', 5);

INSERT INTO Submissions (AssignmentID, StudentID, FileName, FilePath, FileSize, PlagiarismScore, Status, ReviewedBy, ReviewDate, Comments)
VALUES
(1, 6, 'bai1.pdf', '/uploads/bai1.pdf', 2048, 5.00, 'Approved', 1, NOW(), 'Good'),
(2, 7, 'bai2.pdf', '/uploads/bai2.pdf', 4096, 10.00, 'Approved', 1, NOW(), 'Correct logic'),
(3, 8, 'bai3.cpp', '/uploads/bai3.cpp', 1024, 0.00, 'Approved', 2, NOW(), 'Clean code'),
(4, 9, 'bai4.docx', '/uploads/bai4.docx', 3072, 15.50, 'Rejected', 2, NOW(), 'Too similar'),
(5, 10, 'bai5.sql', '/uploads/bai5.sql', 1024, 7.50, 'Approved', 3, NOW(), 'Efficient query'),
(6, 6, 'bai6.docx', '/uploads/bai6.docx', 2048, 3.20, 'Approved', 3, NOW(), 'Nice structure'),
(7, 7, 'bai7.pdf', '/uploads/bai7.pdf', 2560, 12.75, 'Under Review', 4, NULL, NULL),
(8, 8, 'bai8.doc', '/uploads/bai8.doc', 3000, 2.50, 'Pending', NULL, NULL, NULL),
(9, 9, 'bai9.pdf', '/uploads/bai9.pdf', 2800, 0.00, 'Approved', 5, NOW(), 'Excellent'),
(10, 10, 'bai10.docx', '/uploads/bai10.docx', 3200, 18.90, 'Rejected', 5, NOW(), 'Copied content');

INSERT INTO PlagiarismResults (SubmissionID, OriginalText, PlagiarizedText, SourceURL, SimilarityScore, StartPosition, EndPosition)
VALUES
(1, 'ax + b = 0', 'ax + b = 0', 'https://math.com/linear', 5.00, 0, 10),
(2, 'F = ma', 'F = ma', 'https://physics.org/newton', 10.00, 0, 5),
(3, 'for loop', 'for loop', '', 0.00, 0, 0),
(4, 'knn uses...', 'kNN is...', 'https://mlbase.ai/knn', 15.50, 50, 80),
(5, 'SELECT *', 'SELECT *', 'https://sqltips.com/query', 7.50, 0, 12),
(6, 'Dear Sir', 'Dear Sir', 'https://writing.com/formal', 3.20, 0, 15),
(7, 'Essay starts...', 'Article...', '', 12.75, 10, 100),
(8, 'World War I...', 'WWI...', '', 2.50, 20, 80),
(9, 'CH3COOH', 'CH3COOH', '', 0.00, 0, 8),
(10, 'DNA structure', 'Copied DNA structure', 'https://bio.org/dna', 18.90, 5, 50);

INSERT INTO AIInteractions (SubmissionID, UserID, Question, Response, InteractionType)
VALUES
(1, 6, 'T√≥m t·∫Øt b√†i to√°n?', 'B√†i to√°n v·ªÅ ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t', 'Summary'),
(2, 7, 'Gi·∫£i th√≠ch ƒë·ªãnh lu·∫≠t Newton', 'F = ma', 'QA'),
(3, 8, 'Ch·∫°y th·ª≠ code C++', 'Ch·∫°y OK', 'Analysis'),
(4, 9, 'Gi·∫£i th√≠ch sai ph·∫°m', 'Gi·ªëng kNN m·∫´u', 'QA'),
(5, 10, 'SQL t·ªëi ∆∞u?', 'D√πng LIMIT', 'Analysis'),
(6, 6, 'Vi·∫øt ƒëo·∫°n m·ªü b√†i', 'K√≠nh g·ª≠i th·∫ßy...', 'Summary'),
(7, 7, 'Ki·ªÉm tra ng·ªØ ph√°p', 'C√¢u ƒë√∫ng', 'QA'),
(8, 8, 'T√≥m t·∫Øt n·ªôi dung chi·∫øn tranh', 'Chi·∫øn tranh do nhi·ªÅu nguy√™n nh√¢n', 'Summary'),
(9, 9, 'So s√°nh acid', 'Acid m·∫°nh h∆°n', 'Analysis'),
(10, 10, 'Ph√¢n t√≠ch chu·ªói DNA', 'C√≥ 4 base', 'Analysis');


https://chatgpt.com/share/6834c523-91a8-800b-a401-696613979cf9


public async Task<IActionResult> Upload(int exerId, IFormFile pdfFile)
    {
        if (pdfFile != null && pdfFile.Length > 0)
        {
            var fileExt = Path.GetExtension(pdfFile.FileName).ToLower();
            if (fileExt != ".pdf")
            {
                TempData["UploadSuccess"] = "Ch·ªâ ch·∫•p nh·∫≠n file PDF.";
                return RedirectToAction("Details", new { id = exerId });
            }

            var fileName = $"exer_{exerId}_{DateTime.Now:yyyyMMddHHmmss}.pdf";
            var relativePath = $"/uploads/{fileName}";
            var fullPath = Path.Combine(Directory.GetCurrentDirectory(), "wwwroot/uploads", fileName);

            using (var stream = new FileStream(fullPath, FileMode.Create))
            {
                await pdfFile.CopyToAsync(stream);
            }

            // üëâ L∆∞u v√†o database
            var eu = new tblEU
            {
                UID = 1, // T·∫°m th·ªùi hardcode, sau n√†y l·∫•y t·ª´ session / user login
                EID = exerId,
                FilePath = relativePath,
                IsAcepted = false,
                SubmitDate = DateTime.Now
            };

            _context.EUs.Add(eu);
            await _context.SaveChangesAsync();

            TempData["UploadSuccess"] = "N·ªôp b√†i th√†nh c√¥ng!";
            return Redirect("/#services");
        }

        TempData["UploadSuccess"] = "Ch∆∞a ch·ªçn file ho·∫∑c file kh√¥ng h·ª£p l·ªá!";
        return RedirectToAction("Details", new { id = exerId });
    }